<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShockerEngine Pipeline Implementation Plan</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #764ba2;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        h2 {
            color: #5a67d8;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-left: 10px;
            border-left: 4px solid #667eea;
        }
        h3 {
            color: #434190;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 8px;
            border: 1px solid #e0e0ff;
        }
        .pipeline-box {
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .pipeline-box h4 {
            color: #764ba2;
            margin-top: 0;
        }
        ul {
            list-style-type: none;
            padding-left: 0;
        }
        ul li:before {
            content: "▸ ";
            color: #667eea;
            font-weight: bold;
            margin-right: 8px;
        }
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Consolas', 'Monaco', monospace;
            overflow-x: auto;
            margin: 10px 0;
        }
        .highlight {
            background: #fff3cd;
            padding: 15px;
            border-left: 4px solid #ffc107;
            margin: 20px 0;
            border-radius: 4px;
        }
        .advantages {
            background: #d4edda;
            padding: 15px;
            border-left: 4px solid #28a745;
            margin: 20px 0;
            border-radius: 4px;
        }
        .phase-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .phase-card {
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            transition: transform 0.3s ease;
        }
        .phase-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.2);
        }
        .phase-card h4 {
            color: #764ba2;
            margin-top: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #667eea;
            color: white;
        }
        tr:hover {
            background: #f5f5ff;
        }
        .timestamp {
            text-align: right;
            color: #666;
            font-style: italic;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ShockerEngine Pipeline Implementation Plan</h1>
        <p><strong>Objective:</strong> Implement a dual-pipeline ray tracing architecture in ShockerEngine, following the MiloEngine pattern but with separate G-buffer and path tracing pipelines for enhanced flexibility.</p>

        <div class="section">
            <h2>1. ShockerEngine Core Structure</h2>
            <ul>
                <li>Inherit from <code>BaseRenderingEngine</code></li>
                <li>Use existing Shocker handlers (Model, Material, Scene, Render, Denoiser)</li>
                <li>Single Disney material approach (matching MiloEngine)</li>
                <li>No callable programs (simplified architecture)</li>
            </ul>
        </div>

        <div class="section">
            <h2>2. Dual Pipeline Architecture</h2>
            
            <div class="pipeline-box">
                <h4>G-Buffer Pipeline</h4>
                <ul>
                    <li><strong>Purpose:</strong> Fast first-hit geometry queries for deferred rendering</li>
                    <li><strong>Entry point:</strong> <code>setupGBuffers</code></li>
                    <li><strong>Programs:</strong> Ray generation, closest hit, miss</li>
                    <li><strong>Ray depth:</strong> Single bounce (no recursion)</li>
                    <li><strong>Output:</strong> Position, normal, albedo, material IDs in textures</li>
                </ul>
            </div>

            <div class="pipeline-box">
                <h4>Path Tracing Pipeline</h4>
                <ul>
                    <li><strong>Purpose:</strong> Full path tracing with Disney BSDF</li>
                    <li><strong>Entry point:</strong> <code>pathTrace</code></li>
                    <li><strong>Programs:</strong> Ray generation, closest hit, any hit (shadows), miss</li>
                    <li><strong>Ray depth:</strong> Multiple bounces (configurable)</li>
                    <li><strong>Output:</strong> Beauty pass with full global illumination</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>3. Key Design Decisions</h2>
            
            <div class="highlight">
                <h4>Simplifications from Sample Code:</h4>
                <ul>
                    <li>No callable programs (reduced complexity)</li>
                    <li>No per-material BSDF callables</li>
                    <li>No dynamic material switching</li>
                    <li>Material evaluation happens inline in hit shaders</li>
                    <li>Disney BSDF code compiled directly into shaders</li>
                </ul>
            </div>

            <div class="advantages">
                <h4>Advantages of This Approach:</h4>
                <ul>
                    <li>Simpler implementation and debugging</li>
                    <li>Better performance (no indirect calls)</li>
                    <li>Matches existing MiloEngine patterns</li>
                    <li>Flexible rendering modes (preview vs final)</li>
                    <li>Supports denoising with auxiliary buffers</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>4. Program Structure</h2>
            
            <div class="code-block">
<pre>// G-Buffer Pipeline Programs
G-Buffer Pipeline:
  ├── RayGen: setupGBuffers()
  ├── ClosestHit: gbuffer_closesthit() 
  └── Miss: gbuffer_miss()

// Path Tracing Pipeline Programs
Path Tracing Pipeline:
  ├── RayGen: pathTrace()
  ├── ClosestHit: pathtracing_closesthit() // Disney BSDF inline
  ├── AnyHit: shadow_anyhit()
  └── Miss: pathtracing_miss() // Environment sampling</pre>
            </div>
        </div>

        <div class="section">
            <h2>5. Disney Material Integration</h2>
            
            <h3>Material Data Flow:</h3>
            <ul>
                <li>ShockerMaterialHandler manages Disney material parameters</li>
                <li>Material data stored in device buffer</li>
                <li>Hit shaders access material via material ID from SBT</li>
                <li>BSDF evaluation happens directly in closest hit shader</li>
            </ul>

            <h3>Implementation Details:</h3>
            <ul>
                <li>Disney BSDF code compiled into hit shaders</li>
                <li>Shared BSDF headers between shader files</li>
                <li>Material parameters passed through SBT or global buffer</li>
                <li>No runtime material switching overhead</li>
            </ul>
        </div>

        <div class="section">
            <h2>6. Implementation Phases</h2>
            
            <div class="phase-grid">
                <div class="phase-card">
                    <h4>Phase 1: Basic Stub</h4>
                    <ul>
                        <li>Create ShockerEngine class</li>
                        <li>Add pipeline member variables</li>
                        <li>Set up handler connections</li>
                        <li>Initialize render context</li>
                    </ul>
                </div>

                <div class="phase-card">
                    <h4>Phase 2: G-Buffer Pipeline</h4>
                    <ul>
                        <li>Create G-buffer module</li>
                        <li>Implement ray generation</li>
                        <li>Setup hit/miss programs</li>
                        <li>Output to textures</li>
                    </ul>
                </div>

                <div class="phase-card">
                    <h4>Phase 3: Path Tracing</h4>
                    <ul>
                        <li>Create path tracing module</li>
                        <li>Implement recursive tracing</li>
                        <li>Add Disney BSDF</li>
                        <li>Environment sampling</li>
                    </ul>
                </div>

                <div class="phase-card">
                    <h4>Phase 4: Integration</h4>
                    <ul>
                        <li>Pipeline switching logic</li>
                        <li>Render mode selection</li>
                        <li>Denoiser integration</li>
                        <li>Performance tuning</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>7. Shader Binding Table Organization</h2>
            
            <table>
                <thead>
                    <tr>
                        <th>Pipeline</th>
                        <th>Record Type</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td rowspan="3"><strong>G-Buffer</strong></td>
                        <td>Ray Generation</td>
                        <td>Camera and output buffer pointers</td>
                    </tr>
                    <tr>
                        <td>Miss</td>
                        <td>Background/environment handling</td>
                    </tr>
                    <tr>
                        <td>Hit Group</td>
                        <td>One record per geometry instance</td>
                    </tr>
                    <tr>
                        <td rowspan="3"><strong>Path Tracing</strong></td>
                        <td>Ray Generation</td>
                        <td>Camera, sampling state, accumulation buffers</td>
                    </tr>
                    <tr>
                        <td>Miss (per ray type)</td>
                        <td>Environment sampling, null returns</td>
                    </tr>
                    <tr>
                        <td>Hit Group</td>
                        <td>Closest hit + any hit per instance</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="section">
            <h2>8. Pipeline Configuration</h2>
            
            <div class="code-block">
<pre>struct ShockerPipelineConfig {
    // Common settings
    uint32_t maxTraceDepth = 2;        // G-buffer: 1, Path tracing: 2+
    uint32_t stackSize = 0;             // Calculated during link
    
    // G-Buffer specific
    uint32_t gbufferPayloadDwords = 3;  // RGB payload
    
    // Path tracing specific  
    uint32_t pathtracePayloadDwords = 8; // Extended for path state
    uint32_t maxBounces = 8;            // Configurable bounce limit
    
    // Shared settings
    OptixTraversableGraphFlags traversableFlags = 
        OPTIX_TRAVERSABLE_GRAPH_FLAG_ALLOW_SINGLE_LEVEL_INSTANCING;
};</pre>
            </div>
        </div>

        <div class="section">
            <h2>9. Render Mode Management</h2>
            
            <h3>Supported Modes:</h3>
            <ul>
                <li><strong>Preview Mode:</strong> Uses G-buffer pipeline for fast feedback</li>
                <li><strong>Final Mode:</strong> Uses path tracing pipeline for quality</li>
                <li><strong>Debug Mode:</strong> Visualizes individual G-buffer channels</li>
                <li><strong>Hybrid Mode:</strong> Combines both pipelines (future)</li>
            </ul>

            <h3>Mode Switching Logic:</h3>
            <div class="code-block">
<pre>enum class RenderMode {
    GBufferPreview,    // Fast, no GI
    PathTraceFinal,    // Full quality
    DebugNormals,      // G-buffer visualization
    DebugAlbedo,       // Material preview
    DebugDepth         // Depth visualization
};</pre>
            </div>
        </div>

        <div class="section">
            <h2>10. Expected Benefits</h2>
            
            <ul>
                <li><strong>Performance:</strong> G-buffer mode for interactive preview</li>
                <li><strong>Quality:</strong> Path tracing for final renders</li>
                <li><strong>Debugging:</strong> Visualize geometry/materials separately</li>
                <li><strong>Flexibility:</strong> Easy to extend with new pipelines</li>
                <li><strong>Simplicity:</strong> No callable program complexity</li>
                <li><strong>Compatibility:</strong> Works with existing Shocker handlers</li>
            </ul>
        </div>

        <div class="section">
            <h2>11. File Structure</h2>
            
            <div class="code-block">
<pre>framework/engine_core/excludeFromBuild/engines/
├── ShockerEngine.h                 // Main engine class
├── ShockerEngine.cpp               // Implementation
├── ShockerPipelineConfig.h        // Pipeline configuration
└── ShockerLaunchParameters.h      // Launch parameter structures

framework/engine_core/excludeFromBuild/cuda/
├── optix_shocker_gbuffer.cu       // G-buffer shaders
├── optix_shocker_pathtracing.cu   // Path tracing shaders
└── shocker_disney_bsdf.h          // Shared Disney BSDF code</pre>
            </div>
        </div>

        <div class="section">
            <h2>12. Next Steps</h2>
            
            <ol style="list-style-type: decimal; padding-left: 20px;">
                <li>Create ShockerEngine stub class with basic structure</li>
                <li>Define pipeline configuration and launch parameters</li>
                <li>Implement G-buffer pipeline first (simpler)</li>
                <li>Add path tracing pipeline with Disney BSDF</li>
                <li>Integrate with existing Shocker handlers</li>
                <li>Test pipeline switching and render modes</li>
                <li>Optimize performance and memory usage</li>
                <li>Add denoising support for both pipelines</li>
            </ol>
        </div>

        <div class="timestamp">
            Generated: January 2025<br>
            ShockerEngine Pipeline Implementation Plan v1.0
        </div>
    </div>
</body>
</html>